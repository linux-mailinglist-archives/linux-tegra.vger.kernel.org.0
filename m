Return-Path: <linux-tegra-owner@vger.kernel.org>
X-Original-To: lists+linux-tegra@lfdr.de
Delivered-To: lists+linux-tegra@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id 9A0DE21EB59
	for <lists+linux-tegra@lfdr.de>; Tue, 14 Jul 2020 10:30:18 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1725816AbgGNIaR (ORCPT <rfc822;lists+linux-tegra@lfdr.de>);
        Tue, 14 Jul 2020 04:30:17 -0400
Received: from mx2.suse.de ([195.135.220.15]:58940 "EHLO mx2.suse.de"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S1725801AbgGNIaR (ORCPT <rfc822;linux-tegra@vger.kernel.org>);
        Tue, 14 Jul 2020 04:30:17 -0400
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.221.27])
        by mx2.suse.de (Postfix) with ESMTP id ED0DFAC7C;
        Tue, 14 Jul 2020 08:30:18 +0000 (UTC)
Date:   Tue, 14 Jul 2020 10:30:16 +0200
Message-ID: <s5hy2nmv6qv.wl-tiwai@suse.de>
From:   Takashi Iwai <tiwai@suse.de>
To:     Jon Hunter <jonathanh@nvidia.com>
Cc:     <alsa-devel@alsa-project.org>,
        linux-tegra <linux-tegra@vger.kernel.org>
Subject: Re: [PATCH] ALSA: hda: Enable sync-write operation as default for all controllers
In-Reply-To: <8fc9f086-9a34-4287-8f51-6e0ebc34928f@nvidia.com>
References: <20200618144051.7415-1-tiwai@suse.de>
        <8fc9f086-9a34-4287-8f51-6e0ebc34928f@nvidia.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/25.3
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Content-Type: text/plain; charset=US-ASCII
Sender: linux-tegra-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-tegra.vger.kernel.org>
X-Mailing-List: linux-tegra@vger.kernel.org

On Tue, 14 Jul 2020 10:08:02 +0200,
Jon Hunter wrote:
> 
> Hi Takashi,
> 
> On 18/06/2020 15:40, Takashi Iwai wrote:
> > In the end we already enabled the sync-write mode for most of HD-audio
> > controllers including Intel, and it's no big merit to keep the async
> > write mode for the rest.  Let's make it as default and drop the
> > superfluous AZX_DCAPS_SYNC_WRITE bit flag.
> > 
> > Also, avoid to set the allow_bus_reset flag, which is a quite unstable
> > and hackish behavior that was needed only for some early platforms
> > (decades ago).  The straight fallback to the single cmd mode is more
> > robust.
> > 
> > Signed-off-by: Takashi Iwai <tiwai@suse.de>
> 
> 
> I have noticed a regression in HDA playback on our Tegra186 Jetson TX2
> platform. Bisect is pointing to this patch and reverting this does
> appear to fix it. Interestingly, I am not seeing any problems on other
> Tegra platforms, however, Tegra186 does have the IOMMU enabled for HDA
> which is one different between the other platforms.
> 
> We can take a closer look at this for Tegra, but I am wondering if we
> revert this for Tegra for now.

It's a deja vu, we (or someone else in Nvidia?) discussed it in the
past?

The patch below should cure the problem temporarily, as it sets the
polling mode as default for Tegra.  But it'd be appreciated if you can
find the root cause.


thanks,

Takashi

--- a/sound/pci/hda/hda_tegra.c
+++ b/sound/pci/hda/hda_tegra.c
@@ -394,6 +394,7 @@ static int hda_tegra_create(struct snd_card *card,
 	if (err < 0)
 		return err;
 
+	chip->bus.core.polling = 1;
 	chip->bus.core.needs_damn_long_delay = 1;
 
 	err = snd_device_new(card, SNDRV_DEV_LOWLEVEL, chip, &ops);
